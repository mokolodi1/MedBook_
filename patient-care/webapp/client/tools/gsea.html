<template name="listGsea">
  <h1>
    GSEA

    {{#semanticUIPopup selector=".help.circle.icon"}}
      <i class="help circle icon"></i>
      <p class="ui popup">
        Runs the GSEA Preranked and Leading Edge Analysis tools
        created by the Broad Institute of MIT and Harvard.
      </p>
    {{/semanticUIPopup}}
  </h1>

  <h2>Run a new analysis</h2>
  <div class="ui info message">
    <div class="header">
      Linking jobs
    </div>
    <p>
      You can also run GSEA from the output of a job that generates
      a signature.
      Try it now with
      <a href={{pathFor "listLimma"}}>limma</a>
      or <a href={{pathFor "listUpDownGenes"}}>outlier analysis</a>.
    </p>
  </div>
  {{> createGseaForm active=true autoformId="createGsea"}}

  {{> searchableJobs name="RunGSEA" columns=previousJobsCols
      viewJobRouteName="gseaJob"}}
</template>

<template name="createGseaForm">
  {{! NOTE: you can pass gene_set_id to hide that field.
      You must pass active=true in order to load the data needed. This
      is because this template is included in all pages as a modal, which
      means without this it would load the necessary form data and
      keep it loaded for the entire app lifecycle.
      You must also pass autoformId (a string) in order to make the forms
      unique. (AutoForm still sees the form even if the modal it's in
      is hidden.)}}

  {{#autoForm id=autoformId schema=createGseaSchema
      type="method" meteormethod="createGsea"
      class=(loadingIfFalse Template.subscriptionsReady)}}
    {{#if gene_set_id}}
      {{> afQuickField name="gene_set_id" type="hidden"
          value=gene_set_id}}
    {{else}}
      {{> afQuickField name="gene_set_id" type="select"
          options=geneSetOptions search=true
          placeholder="Which gene set would you like to use?"}}
    {{/if}}

    {{#if availableSortFields}}
      {{> afQuickField name="gene_set_sort_field"
          options=availableSortFields type="select" search=true
          placeholder="Which field should we use to rank the gene set?"}}
    {{/if}}

    {{> afQuickField name="gene_set_group_ids"
        options=geneSetGroupOptions type="select" search=true
        placeholder="Select gene set groups..." multiple=true}}

    {{#if duplicateGeneSetNames}}
      <div class="ui warning message">
        <div class="header">
          Duplicate gene set names
        </div>
        <p>
          The chosen gene set groups have duplicate gene set names.
        </p>
        <p>
          Please deselect gene set groups containing duplicate
          gene set names.
        </p>
      </div>
    {{/if}}

    <div class="ui accordion field">
      <div class="title">
        <i class="icon dropdown"></i>
        Advanced arguments

        <i class="help circle icon"></i>
        <div class="ui popup">
          <a href="http://software.broadinstitute.org/gsea/doc/GSEAUserGuideFrame.html">
            See here for detailed documentation.
          </a>
        </div>
      </div>

      {{! display: none so they don't show up at the beginning.
          Thanks @ArnaudGallardo!}}
      <div class="six fields" style="display: none;">
        {{> afQuickField name="set_min" value=15}}
        {{> afQuickField name="set_max" value=500}}
        {{> afQuickField name="plot_top_x" value=20}}
        {{> afQuickField name="nperm" value=1000}}
        {{> afQuickField name="metric" value="Signal2Noise"
            type="select" options="allowed"}}
        {{> afQuickField name="scoring_scheme" value="weighted"
            type="select" options="allowed"}}
      </div>
    </div>

    {{! don't allow them to start a job that will break}}
    <button type="submit" class="ui primary button
        {{#if duplicateGeneSetNames}}disabled{{/if}}">
      Start analysis
    </button>
  {{/autoForm}}
</template>

<template name="gseaJob">
  {{#jobWrapper jobOptions}}
    {{#if output.skipped_leading_edge}}
      <h2>No heatmap is available</h2>
      <div style="overflow: auto; width: 100%;">
          GSEA found exactly one enriched gene set, but Leading Edge Analysis requires two or more
          input gene sets to run.
      </div>
    {{else}}
      <h2>Heatmap: samples vs. gene sets</h2>
      <div style="overflow: auto; width: 100%;">
        {{#with getJobResultUrl "leading_edge_heat_map_clustered.png"}}
          <a href={{this}} target="_blank" title="Click to open in new tab">
            <img src={{this}}
                alt="Heatmap generated by Leading Edge Analysis" />
          </a>
        {{/with}}
      </div>
    {{/if}}

    <h2>
      Full Report

      <div class="ui icon primary button gsea-iframe-new-tab" target="_blank">
        <i class="external icon"></i>
        Open in new tab
      </div>
    </h2>
    <iframe id="gsea-report" src={{getJobResultUrl "index.html"}}
        style="height: 500px; width: 100%">
    </iframe>
  {{/jobWrapper}}
</template>

<template name="gseaJobArgs">
  <table class="ui celled striped table">
    <thead>
      <tr>
        <th colspan="2">Arguments</th>
      </tr>
    </thead>
    <tbody>
      {{! NOTE: these names are also in listGsea.js }}
      <tr>
        <td>Gene set</td>
        <td>
          {{#linkToGeneSet args.gene_set_id}}
            {{../args.gene_set_name}}
          {{/linkToGeneSet}}
        </td>
      </tr>
      <tr>
        <td>Gene set sort field</td>
        <td>{{args.gene_set_sort_field}}</td>
      </tr>
      <tr>
        <td>Gene set groups</td>
        <td>
          <div class="ui list">
            {{#each args.gene_set_group_names}}
              {{! NOTE: assumes that names and ids arrays match up}}
              <a href={{pathFor "manageObjects" collectionSlug="gene-set-groups"
                  selected=(getGeneSetGroupId @index ..)}}
                  class="item">
                {{this}}
              </a>
            {{/each}}
          </div>
        </td>
      </tr>
      <tr>
        <td>Minimum size gene set</td>
        <td>{{args.set_min}}</td>
      </tr>
      <tr>
        <td>Maximum size gene sest</td>
        <td>{{args.set_max}}</td>
      </tr>
      <tr>
        <td>Top pathways count</td>
        <td>{{args.plot_top_x}}</td>
      </tr>
      <tr>
        <td>Permutation count</td>
        <td>{{args.nperm}}</td>
      </tr>
      <tr>
        <td>Metric for ranking genes</td>
        <td>{{args.metric}}</td>
      </tr>
      <tr>
        <td>Scoring statistic</td>
        <td>{{args.scoring_scheme}}</td>
      </tr>
    </tbody>
  </table>
</template>

<template name="linkToGeneSet">
  {{#if Template.subscriptionsReady}}
    <a href={{geneSetUrl}}>
      {{> Template.contentBlock this}}
    </a>
  {{else}}
    {{> Template.contentBlock this}}
  {{/if}}
</template>
